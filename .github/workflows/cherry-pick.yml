---
name: Cherry pick to stable branches

on:
  pull_request:
    types:
      - closed

env:
  GIT_AUTHOR_NAME: Foreman Cherry Picker
  GIT_AUTHOR_EMAIL: cherry-picker@theforeman.org

jobs:
  branches:
    name: Determine branches
    runs-on: ubuntu-latest
    outputs:
      versions: ${{ steps.parse.outputs.versions }}
    steps:
      - name: Parse PR message
        id: parse
        if: ${{ github.event.pull_request.merged }}
        run: |
          awk '/^\* \[x\] Foreman [0-9]+\.[0-9]+\s*$/ { print $4 }' <<EOF | python3 -c 'import json, sys ; print(f"::set-output name=versions::{json.dumps(sys.stdin.read().split())}")'
          ${{ github.event.pull_request.body }}
          EOF

  pick:
    name: Create PR
    runs-on: ubuntu-latest
    needs: branches
    strategy:
      fail-fast: false
      matrix:
        version: ${{ fromJson(needs.branches.outputs.versions) }}
    steps:
      - name: Checkout ${{ matrix.version }}
        uses: actions/checkout@v2
        with:
          ref: ${{ matrix.version }}
          # To get the whole history so we can cherry pick
          fetch-depth: 0
      - run: git cherry-pick -x ${{ github.event.pull_request.merge_commit_sha }}
      - name: Open a PR
        uses: peter-evans/create-pull-request@v3
        with:
          title: "[${{ matrix.version }}] ${{ github.event.pull_request.title }}"
          branch: "${{ matrix.version }}-pick-${{ github.event.pull_request.number }}"
          body: |
            Automated cherry pick of ${{ github.event.pull_request.html_url }} for the ${{ matrix.version }} branch.

            This only picks ${{ github.event.pull_request.merge_commit_sha }}. If there were multiple commits, this cherry pick is incomplete and a manual pick must be created.
          delete-branch: true
